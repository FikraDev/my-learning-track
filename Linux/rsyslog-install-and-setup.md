# Install and Setup rsyslog on Ubuntu

- rsylog is a utility that is used to forward log messages in a client-server model.
- When configured as a client, it sends logs to a remote server over the network via TCP/UDP protocols.
- As a server, it receives logs over the network from remote client on port 514 TCP/UDP or any custom port on which it is configured to listen on.
- Rsyslog is the default syslogd on Debian systems and is usually installed on Ubuntu by default.

- To check is ryslog is installed: `apt list -a rsyslog` or `rsyslog --version`

## Install rsyslog

- To install rsyslog: `sudo apt update` then `sudo apt install rsyslog -y`
- Once the application is installed enable it: `sudo systemctl enable --now rsyslog`

## Setup a device as rsyslog server

- open the ryslog config file: `sudo vim /etc/rsyslog.conf`
- rsyslog to use both UDP and TCP protocols for logs reception over the ports **514 and 50514** respectively.  By default syslog uses UDP port 514.  There to enable UDP syslog reception:
  - in the modules section, uncomment the lines under *'# provides UDP syslog reception'*.
  - optionally you can enable reception under TCP instead by following the steps outlined previously.
- Save and exit the file
- Restart the service `sudo systemctl restart rsyslog`.
- Verify that the service is running: `sudo ss -4altunp | grep 514`
- If firewall is running, allow rsyslog through: `sudo ufw allow 514/udp` and `sudo ufw allow 50514/tcp`

- **Allow Specific Senders**:
  - To allow only specific machines to send logs to your rsyslog server:
    - open the config file: `vim /etc/rsyslog.conf`
    - Navigate to the "Modules" Module and add the machine just below `# provides TCP syslog reception` after `input(type="imtcp" port="514")` using the syntax: `$AllowedSender [UDP/TCP], ip[/bits], ip[/bits]` eg:
    `$AllowedSender UDP, 192.168.58.10`.  To allow from an entire network/subnet: `$AllowedSender UDP, 192.168.58.0/24,`
    - Multiple allowed senders can be added in a comma seperated list.
    - It is also a good idea to allow the allowedSender through the firewall as well `ufw allow from 192.168.58.0/24 to any port 514 proto udp`.

- **Configure Templates**:
  - Templates are used to modify and format logs generated by rsyslog in a custom manner
  - Templates are created in the */etc/rsyslog.conf* file.
  - This is a simple template.  These two lines should be placed just above the *Global Directives* module:
  
  ```bash
  $template remote-incoming-logs, "/var/log/%HOSTNAME%/%PROGRAMNAME%.log"
  *.* ?remote-incoming-logs
  ```

  - Once done save and exit the file.  This will create a file with the hostname of the client(s) in the /var/log directory.
  - Run a config check: `sudo rsyslogd -f /etc/rsyslog.conf -N1`
  - If the config check is passed, restart the service: `sudo systemctl restart rsyslog`

- Server is now configured.

## Configure device as rsyslog client

- Verify connectivity to the remote syslog server:
  - TCP: `telnet serverIP 50514`
  - UDP: On the server run `sudo nc -ul 514`.  On the client run `nc -u serverIP 514`.
  - If all checks out, edit the config file to push logs to the server.
  - Open the config file: `vim /etc/rsyslog.conf`
  - To send all logs over port 50514/TCP, add the following line to the end of the file: `*.* @@server_IP:50514`
  - To send for example authentication logs only: `auth,authpriv.* @192.168.59.38:514`
  - *Note*: @@ is also used for UDP

  ***Note***: The method used and the port us is dependent on the $AllowSender directive that was setup on the server. Therefore if the host/network is defined to send only using UDP, when configuring the client it must use the same method.

- As a cushion just in case the remote rsyslog server goes down and your logs are so important you donâ€™t want to loose, set the rsyslog disk queue for buffering in the rsyslog configuration file as shown below:

  ```bash
  #Define Disk Queue Buffer in case the server goes down
  $ActionQueueFileName queue # define a file name for disk assistance.
  $ActionQueueMaxDiskSpace 1g  # The maximum size that all queue files together will use on disk.
  $ActionQueueSaveOnShutdown on  # specifies that data should be saved at shutdown
  $ActionQueueType LinkedList  # holds enqueued messages in memory which makes the process very fast.
  $ActionResumeRetryCount -1  # prevents rsyslog from dropping messages when retrying to connect if server is not responding
  ```

- Once done, restart the service on the client:
  `systemctl restart rsyslog`

- **Verify logs are working**:
  - Login into the syslog server and verify the clients allowed to send logs to it:
    ```sudo ls -1 /var/log/remotelogs/```
  
  - To see the logs sent by a particular server:
    `sudo ls -1 /var/log/remotelogs/client_pc_IP/`

- Some standard log files are:

  - auth,authpriv.*
  - *.*;auth,authpriv.none
  - #cron.*
  - daemon.*
  - kern.*
  - lpr.*
  - mail.*
  - user.*

***Any config change made on the server will require a restart of the rsyslog service on bothe the server and the clients as well.  In order to view the logs it may require changing the ownership of the files from syslog to the logged in user otherwise use root which is not recommended***
  
***Credit: steps here taken from article "https://kifarunix.com/install-and-setup-rsyslog-server-on-ubuntu/"***
